syntax = "proto3";

package tunnel;

enum ClientType {
  UNKNOWN = 0;
  LAPTOP = 1;
  BROWSER = 2;
}

enum FrameType {
  UNKNOWN_FRAME = 0;
  HTTP_REQUEST = 1;
  HTTP_RESPONSE = 2;
  PING = 3;
  PONG = 4;
  DATA = 5;
}

message RegistrationRequest {
  string client_id = 1;
  ClientType client_type = 2;
  repeated string capabilities = 3;
  string local_app_url = 4;
}

message RegistrationResponse {
  string client_id = 1;
  string tunnel_id = 2;
  string server_version = 3;
  bool success = 4;
  string message = 5;
  int64 timestamp = 6;
}

message HttpRequest {
  string request_id = 1;
  string method = 2;
  string path = 3;
  string headers = 4; 
  bytes body = 5;
  string query = 6; 
}

message HttpResponse {
  string request_id = 1;
  int32 status = 2;
  string headers = 3;
  bytes body = 4;
}

message TunnelFrame {
  string frame_id = 1;
  FrameType type = 2;
  bytes payload = 3;
  int64 timestamp = 4;
  map<string, string> metadata = 5;
}

message HealthCheckMsg {
  string service = 1;
}

message HealthResponseMsg {
  string status = 1;
  int64 timestamp = 2;
}

message PollRequest {
  string client_id = 1;
  string tunnel_id = 2;
  string last_frame_id = 3;
  int32 timeout_ms = 4;
}

message PollResponse {
  repeated TunnelFrame frames = 1;
  bool has_more = 2;
  string next_poll_in = 3;
}

message SendFrameRequest {
  TunnelFrame frame = 1;
  string client_id = 2;
  string tunnel_id = 3;
}

message SendFrameResponse {
  bool success = 1;
  string message = 2;
  int64 timestamp = 3;
}

service TunnelService {
  rpc Register(RegistrationRequest) returns (RegistrationResponse);
  
  rpc HealthCheck(HealthCheckMsg) returns (HealthResponseMsg);
  
  rpc TunnelStream(stream TunnelFrame) returns (stream TunnelFrame);
  
  rpc SendFrame(SendFrameRequest) returns (SendFrameResponse);
  
  rpc PollFrames(PollRequest) returns (PollResponse);
  
  rpc KeepAlive(HealthCheckMsg) returns (HealthResponseMsg);
}
